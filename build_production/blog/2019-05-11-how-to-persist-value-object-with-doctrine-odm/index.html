<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="How to persist Value Object with Doctrine ODM">

        <meta property="og:title" content="How to persist Value Object with Doctrine ODM | @lucasxciv"/>
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://lucasxciv.dev/blog/2019-05-11-how-to-persist-value-object-with-doctrine-odm"/>
        <meta property="og:description" content="How to persist Value Object with Doctrine ODM" />

        <title>How to persist Value Object with Doctrine ODM | @lucasxciv</title>

        <link rel="home" href="https://lucasxciv.dev">
        <link rel="icon" href="/assets/img/logo.jpeg">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="@lucasxciv Atom Feed">

                    <!-- Insert analytics code here -->
        
        <link rel="stylesheet" href="/assets/build/css/main.css?id=63adab265308ca0d59e018de30ed4785">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-base3 text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-base2 py-4" role="banner">
            <div class="container flex items-center max-w-5xl mx-auto px-4 lg:px-8">
                <div id="vue-search" class="grid mx-auto text-center">
                    <div class="text-center items-center justify-center">
                        <img class="h-20 mx-auto shadow border-solid border-4 border-base3 rounded-full" src="/assets/img/logo.jpeg" alt="@lucasxciv logo" />
                    </div>
                    <div class="mt-2">
                        <h1 class="text-2xl text-base01 font-semibold my-0">Lucas de Oliveira</h1>
                        <h1 class="text-xs text-base01 font-semibold my-0">software developer</h1>
                    </div>

                    <nav class="hidden lg:flex items-center text-center text-sm mt-4">
    <a title="@lucasxciv Blog" href="/"
        class="mx-3 text-base01 hover:text-base1 ">
        Blog
    </a>

    <a title="@lucasxciv About" href="/about"
        class="mx-3 text-base01 hover:text-base1 ">
        About
    </a>

    <a title="@lucasxciv Contact"
       href="https://www.linkedin.com/in/lucasxciv"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        LinkedIn <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>

    <a title="@lucasxciv Contact"
       href="https://github.com/lucasxciv"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        GitHub <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>

    <a title="@lucasxciv Contact"
       href="https://x.com/lucasxciv"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        Twitter <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>

    <a title="@lucasxciv Contact"
       href="https://nostr.lucasxciv.dev"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        Nostr <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>

    <a title="@lucasxciv Contact"
       href="https://stackoverflow.com/users/7435669/lucasxciv"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        Stack Overflow <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>
</nav>

                    <button class="flex justify-center items-center bg-base3 shadow h-10 px-5 rounded-full lg:hidden focus:outline-none mt-4"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-base03 h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-base03 h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="w-auto px-2 pt-6 pb-2 bg-base2 shadow hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="@lucasxciv Blog"
                href="/"
                class="block mt-0 mb-4 text-sm text-base01 hover:text-base1 "
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv About"
                href="/about"
                class="block mt-0 mb-4 text-sm text-base01 hover:text-base1 text-base01 hover:text-base1"
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://www.linkedin.com/in/lucasxciv"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >LinkedIn <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://github.com/lucasxciv"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >GitHub <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://x.com/lucasxciv"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >Twitter <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://nostr.lucasxciv.dev"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >Nostr <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://stackoverflow.com/users/7435669/lucasxciv"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >Stack Overflow <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-16 px-6">
                
    <h1 class="leading-none mb-2 text-base01">How to persist Value Object with Doctrine ODM</h1>

    <p class="text-base0 text-xl md:mt-0">de Oliveira, Lucas  •  June 9, 2019</p>

                        <a
                href="/blog/categories/php"
                title="View posts in php"
                class="inline-block bg-base2 hover:text-base1 leading-loose tracking-wide text-base01 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >php</a>
                    <a
                href="/blog/categories/mongodb"
                title="View posts in mongodb"
                class="inline-block bg-base2 hover:text-base1 leading-loose tracking-wide text-base01 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >mongodb</a>
                    <a
                href="/blog/categories/doctrine"
                title="View posts in doctrine"
                class="inline-block bg-base2 hover:text-base1 leading-loose tracking-wide text-base01 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >doctrine</a>
            
    <div class="border-b border-base2 mb-10 pb-4 text-base01" v-pre>
        <p>I have been working the last couple years with Doctrine ODM in production environment and in some situations I needed to improve my code applying the concept of Value Object/Type, that is a very important pattern to avoid creation of invalid object and to improve the design of the domain code.</p>

<p>In this post I will describe a short review of Value Object/Type and then show how to apply this concept and persist on the database using Doctrine ODM.</p>

<h2>Short review about Value Object/Type</h2>

<p>In some books you can see the author calling this pattern of Value Object and in other of Value Type, in this post from now on I will call it just of Value Object.</p>

<p>Value Objects are small objects that represents a value, two Value Objects with the same state are equals, the main characteristics of a Value Object are that it is immutable and does not have an identity. We can use Value Object to help create a consistent domain model that could be easier to understand, such as, if we create a <code>Money</code> Value Object in our code instead of just using <code>float</code>, we can let all the rules that is relevant to create a money value inside the same object, then if we need to change some of these rules we just go in one place, also all the objects that need a money type will have it already validated, these things can reduce the risk of confusion and duplication.</p>

<p>We can find more about this concept of Value Object in many books or articles, like any books of DDD by Eric Evans or Vaughn Vernon, Refactoring by Martin Fowler, Growing Objects-Oriented Software by Steve Freeman and Nat Pryce, and a many other books and articles that have as the goal improve the software design and consistency.</p>

<p>So, before I start showing the code, let's assume that our Value Object definition is, as described in <a href="https://martinfowler.com/bliki/ValueObject.html">Martin Fowler's article</a>:</p>

<blockquote>
  <p><em>"Objects that are equal due to the value of their properties..."</em></p>
</blockquote>

<h2>Persisting Value Object with Doctrine ODM</h2>

<p>To persist Value Object using Doctrine ODM I can simply use the <a href="https://www.doctrine-project.org/projects/doctrine-mongodb-odm/en/1.2/reference/basic-mapping.html#custom-mapping-types">Custom Mapping Types</a> or <a href="https://www.doctrine-project.org/projects/doctrine-mongodb-odm/en/1.2/reference/annotations-reference.html#embedone">@EmbedOne Annotation</a> that the framework provides. Beyond Doctrine ODM I will also install other two packages, one to create Uuid, that is <a href="https://github.com/ramsey/uuid">ramsey/uuid</a> and other one to help validate the input data, that is <a href="https://github.com/beberlei/assert">beberlei/assert</a>.</p>

<p>For example, if I have a product entity with three properties that are these Value Objects: <code>IdProduct</code>, <code>Name</code> and <code>Price</code>, I can create a custom type for <code>IdProduct</code> and <code>Name</code> that are Value Objects that have only one attribute and the only thing I need to do before persist is convert the object to a MongoDB type, and for <code>Money</code> Value Object I can use the <code>@EmbedOne</code> annotation because it has two attributes, <code>value</code> and <code>currency</code>, so I can do something like this:</p>

<ul>
<li>Entity <code>Product</code>:</li>
</ul>

<pre><code class="language-php">&lt;?php

namespace Store;

use Doctrine\ODM\MongoDB\Mapping\Annotations as ODM;

/** @ODM\Document(collection="Product") */
class Product
{

    /**
     * @ODM\Id(type="product.id", strategy="NONE")
     * @var IdProduct
     */
    private $idProduct;

    /**
     * @ODM\Field(type="product.name")
     * @var Name
     */
    private $name;

    /**
     * @ODM\EmbedOne(name="price", targetDocument="Store\Money")
     * @var Money
     */
    private $price;

    private function __construct()
    {
        $this-&gt;idProduct = IdProduct::instance();
    }

    public function id() : IdProduct
    {
        return $this-&gt;idProduct;
    }

    public function name() : Name
    {
        return $this-&gt;name;
    }

    public function price() : Money
    {
        return $this-&gt;price;
    }

    public static function newProduct(Name $name, Money $price) : self
    {
        $instance = new self();
        $instance-&gt;name = $name;
        $instance-&gt;price = $price;
        return $instance;
    }
}
</code></pre>

<ul>
<li>Value Object <code>ProductId</code>:</li>
</ul>

<pre><code class="language-php">&lt;?php

namespace Store;

use Ramsey\Uuid\Uuid;
use Ramsey\Uuid\UuidInterface;

class IdProduct
{

    /** @var UuidInterface */
    private $uuid;

    private function __construct(UuidInterface $uuid)
    {
        $this-&gt;uuid = $uuid;
    }

    public function toString() : string
    {
        return $this-&gt;uuid-&gt;toString();
    }

    public static function instance() : self
    {
        return new self(Uuid::uuid4());
    }
}
</code></pre>

<ul>
<li>Value Object <code>Name</code>:</li>
</ul>

<pre><code class="language-php">&lt;?php

namespace Store;

use Assert\Assertion;

class Name
{

    /** @var string */
    private $name;

    private function __construct(string $name)
    {
        $this-&gt;name = $name;
    }

    public function toString() : string
    {
        return $this-&gt;name;
    }

    public static function fromString(string $name) : self
    {
        Assertion::minLength($name, 3, 'Name must have at least 3 characters');

        return new self($name);
    }
}
</code></pre>

<ul>
<li>Value Object <code>Money</code>:</li>
</ul>

<pre><code class="language-php">&lt;?php

namespace Store;

use Assert\Assertion;
use Doctrine\ODM\MongoDB\Mapping\Annotations as ODM;

/** @ODM\EmbeddedDocument() */
class Money
{

    /** @var string */
    public const USD = 'USD';

    /**
     * @ODM\Field(name="value", type="float")
     * @var float
     */
    private $value;

    /**
     * @ODM\Field(name="currency", type="string")
     * @var string
     */
    private $currency;

    private function __construct(float $value, string $currency)
    {
        $this-&gt;value = $value;
        $this-&gt;currency = $currency;
    }

    public function value() : float
    {
        return $this-&gt;value;
    }

    public function currency() : string
    {
        return $this-&gt;currency;
    }

    public static function USD(float $value) : self
    {
        Assertion::min($value, 0, 'Money must be positive value');

        return new self($value, static::USD);
    }
}
</code></pre>

<p>And then the Doctrine ODM Custom Types.</p>

<ul>
<li>Custom Type <code>IdProductType</code>:</li>
</ul>

<pre><code class="language-php">&lt;?php

namespace Store\Type;

use Doctrine\ODM\MongoDB\Types\ClosureToPHP;
use Doctrine\ODM\MongoDB\Types\Type;
use Ramsey\Uuid\Uuid;
use Store\IdProduct;

class IdProductType extends Type
{

    use ClosureToPHP;

    public function convertToPHPValue($value)
    {
        return Uuid::fromString((string)$value);
    }

    public function convertToDatabaseValue($value)
    {
        return $value instanceof IdProduct ? $value-&gt;toString() : $value;
    }
}
</code></pre>

<ul>
<li>Custom Type <code>NameType</code>:</li>
</ul>

<pre><code class="language-php">&lt;?php

namespace Store\Type;

use Doctrine\ODM\MongoDB\Types\ClosureToPHP;
use Doctrine\ODM\MongoDB\Types\Type;
use Store\Name;

class NameType extends Type
{

    use ClosureToPHP;

    public function convertToPHPValue($value)
    {
        return Name::fromString((string)$value);
    }

    public function convertToDatabaseValue($value)
    {
        return $value-&gt;toString();
    }
}
</code></pre>

<p>After I created the custom types I have to register it on Doctrine ODM. I can only use the type <code>product.id</code> and <code>product.name</code> on the <code>@Field</code> annotation because it was registered on Doctrine:</p>

<pre><code class="language-php">&lt;?php

use Doctrine\ODM\MongoDB\Types\Type;

Type::addType('product.id', Store\Type\IdProductType::class);
Type::addType('product.name', Store\Type\NameType::class);
</code></pre>

<p>Finally, when I persist the <code>Product</code> entity I will have this result on MongoDB:</p>

<pre><code class="language-js">&gt; db.Product.find().pretty()
{
    "_id" : "fb67f250-d36e-43bd-a0de-4f54f32d67f0",
    "name" : "Notebook",
    "price" : {
        "value" : 1000,
        "currency" : "USD"
    }
}
</code></pre>

<p>I hope this post could have helped you understand how to persist Value Objects using Doctrine ODM, <a href="https://github.com/deoliveiralucas/persist-value-object-doctrine-odm">check out my Github repository</a> if you want to see and execute all the source code.</p>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://lucasxciv.dev/blog/2019-03-19-dicas-para-iniciar-um-projeto-em-php" title="Older Post: Dicas para iniciar um projeto em PHP" class="text-base01 hover:text-base1">
                    &LeftArrow; Dicas para iniciar um projeto em PHP
                </a>
                    </div>

        <div>
                            <a href="https://lucasxciv.dev/blog/2019-08-12-testando-novas-funcionalidades-do-php-7-4" title="Newer Post: Testando Novas Funcionalidades do PHP 7.4" class="text-base01 hover:text-base1">
                    Testando Novas Funcionalidades do PHP 7.4 &RightArrow;
                </a>
                    </div>
    </nav>

    <hr />
    <script src="https://giscus.app/client.js"
            data-repo="lucasxciv/lucasxciv.github.io"
            data-repo-id="MDEwOlJlcG9zaXRvcnk0NzYxOTYwMw=="
            data-category="Comments"
            data-category-id="DIC_kwDOAtaeE84CjAD7"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="noborder_light"
            data-lang="en"
            crossorigin="anonymous"
            async>
    </script>
        </main>

        <footer class="bg-base2 text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; 2015-2024 • <a href="https://lucasxciv.dev" title="@lucasxciv" class="text-base01 hover:text-base1">lucasxciv.dev</a> • All rights reserved.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=e4a964d2b186fcedcfeb820ced60e3fb"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
